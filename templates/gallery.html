<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DICOM Image Viewer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .dicom-viewer {
            background-color: #000;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .dicom-image {
            max-width: 100%;
            max-height: 70vh;
            object-fit: contain;
            background-color: #000;
            border-radius: 8px;
        }
        .controls-panel {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .slice-slider {
            width: 100%;
            margin: 15px 0;
        }
        .slice-info {
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }
        .metadata-panel {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }
        .navigation-buttons {
            text-align: center;
            margin: 15px 0;
        }
        .btn-nav {
            margin: 0 5px;
            min-width: 80px;
        }
        .viewer-container {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>DICOM Image Viewer</h2>
                    <div>
                        <a href="{{ url_for('index') }}" class="btn btn-primary">Upload More Files</a>
                        <form action="{{ url_for('cleanup_session', session_id=session_id) }}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete all uploaded files?')">
                                Clean Up Files
                            </button>
                        </form>
                    </div>
                </div>
                
                {% if images %}
                    <!-- Series Information -->
                    <div class="controls-panel">
                        <h5>üìä Series Information</h5>
                        <div class="row">
                            <div class="col-md-3"><strong>Total Series:</strong> {{ series_info.total_series }}</div>
                            <div class="col-md-3"><strong>Images in Series:</strong> {{ series_info.total_images }}</div>
                            {% if images[0].info %}
                                <div class="col-md-3"><strong>Patient:</strong> {{ images[0].info.patient_name }}</div>
                                <div class="col-md-3"><strong>Modality:</strong> {{ images[0].info.modality }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Image Viewer -->
                    <div class="viewer-container">
                        <div class="dicom-viewer">
                            <img id="dicomImage" src="{{ images[0].image_data }}" class="dicom-image" alt="DICOM Image">
                        </div>
                        
                        <!-- Navigation Controls -->
                        <div class="controls-panel">
                            <div class="slice-info">
                                <span id="sliceInfo">Slice <span id="currentSlice">1</span> of {{ images|length }}</span>
                            </div>
                            
                            <!-- Navigation Buttons -->
                            <div class="navigation-buttons">
                                <button id="firstBtn" class="btn btn-outline-secondary btn-nav" onclick="goToSlice(0)">‚è™ First</button>
                                <button id="prevBtn" class="btn btn-outline-primary btn-nav" onclick="previousSlice()">‚óÄ Prev</button>
                                <button id="playBtn" class="btn btn-success btn-nav" onclick="togglePlayback()">‚ñ∂ Play</button>
                                <button id="nextBtn" class="btn btn-outline-primary btn-nav" onclick="nextSlice()">Next ‚ñ∂</button>
                                <button id="lastBtn" class="btn btn-outline-secondary btn-nav" onclick="goToSlice({{ images|length - 1 }})">Last ‚è©</button>
                            </div>
                            
                            <!-- Slice Slider -->
                            <div class="row">
                                <div class="col-12">
                                    <input type="range" id="sliceSlider" class="form-range slice-slider" 
                                           min="0" max="{{ images|length - 1 }}" value="0" 
                                           onchange="goToSlice(this.value)" oninput="goToSlice(this.value)">
                                </div>
                            </div>
                            
                            <!-- Playback Speed -->
                            <div class="row mt-3">
                                <div class="col-6">
                                    <label for="speedSlider" class="form-label">Playback Speed:</label>
                                    <input type="range" id="speedSlider" class="form-range" min="1" max="10" value="3" onchange="updatePlaybackSpeed(this.value)">
                                    <small class="text-muted">Speed: <span id="speedValue">3</span> FPS</small>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">Quick Navigation:</label><br>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-info" onclick="goToSlice(0)">Start</button>
                                        <button class="btn btn-outline-info" onclick="goToSlice(Math.floor(({{ images|length - 1 }}) / 2))">Middle</button>
                                        <button class="btn btn-outline-info" onclick="goToSlice({{ images|length - 1 }})">End</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Current Slice Metadata -->
                    <div class="metadata-panel">
                        <h6>Current Slice Metadata:</h6>
                        <div class="row" id="metadataContent">
                            {% if images[0].info %}
                                <div class="col-md-6">
                                    <table class="table table-sm">
                                        <tr><td><strong>Filename:</strong></td><td id="metaFilename">{{ images[0].filename }}</td></tr>
                                        <tr><td><strong>Patient Name:</strong></td><td id="metaPatientName">{{ images[0].info.patient_name }}</td></tr>
                                        <tr><td><strong>Patient ID:</strong></td><td id="metaPatientId">{{ images[0].info.patient_id }}</td></tr>
                                        <tr><td><strong>Study Date:</strong></td><td id="metaStudyDate">{{ images[0].info.study_date }}</td></tr>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <table class="table table-sm">
                                        <tr><td><strong>Instance Number:</strong></td><td id="metaInstanceNumber">{{ images[0].info.instance_number }}</td></tr>
                                        <tr><td><strong>Slice Location:</strong></td><td id="metaSliceLocation">{{ "%.2f"|format(images[0].info.slice_location) }}</td></tr>
                                        <tr><td><strong>Series Description:</strong></td><td id="metaSeriesDescription">{{ images[0].info.series_description }}</td></tr>
                                        {% if images[0].info.image_size %}
                                            <tr><td><strong>Image Size:</strong></td><td id="metaImageSize">{{ images[0].info.image_size }}</td></tr>
                                        {% endif %}
                                    </table>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-info text-center">
                        <h4>No DICOM Images Found</h4>
                        <p>No valid DICOM files were found in the uploaded files.</p>
                        <a href="{{ url_for('index') }}" class="btn btn-primary">Try Again</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // DICOM Image Data
        const images = {{ images | tojsonfilter }} || [];
        let currentSliceIndex = 0;
        let isPlaying = false;
        let playbackInterval = null;
        let playbackSpeed = 3; // FPS
        
        // Guard function to check if images are available
        function isImagesAvailable() {
            return images && Array.isArray(images) && images.length > 0;
        }
        
        function goToSlice(index) {
            if (!isImagesAvailable()) {
                console.warn('No images available for navigation');
                return;
            }
            
            index = parseInt(index);
            if (index < 0 || index >= images.length) return;
            
            currentSliceIndex = index;
            
            try {
                // Update image
                const imageElement = document.getElementById('dicomImage');
                if (imageElement && images[index] && images[index].image_data) {
                    imageElement.src = images[index].image_data;
                }
                
                // Update slice info
                const currentSliceElement = document.getElementById('currentSlice');
                if (currentSliceElement) {
                    currentSliceElement.textContent = index + 1;
                }
                
                const sliceSliderElement = document.getElementById('sliceSlider');
                if (sliceSliderElement) {
                    sliceSliderElement.value = index;
                }
                
                // Update metadata
                updateMetadata(images[index]);
                
                // Update button states
                updateButtonStates();
            } catch (error) {
                console.error('Error in goToSlice:', error);
            }
        }
        
        function updateMetadata(imageData) {
            if (!imageData || !imageData.info) {
                console.warn('No image metadata available');
                return;
            }
            
            try {
                document.getElementById('metaFilename').textContent = imageData.filename || 'Unknown';
                document.getElementById('metaPatientName').textContent = imageData.info.patient_name || 'Unknown';
                document.getElementById('metaPatientId').textContent = imageData.info.patient_id || 'Unknown';
                document.getElementById('metaStudyDate').textContent = imageData.info.study_date || 'Unknown';
                document.getElementById('metaInstanceNumber').textContent = imageData.info.instance_number || 'Unknown';
                document.getElementById('metaSliceLocation').textContent = parseFloat(imageData.info.slice_location || 0).toFixed(2);
                document.getElementById('metaSeriesDescription').textContent = imageData.info.series_description || 'Unknown';
                if (imageData.info.image_size) {
                    const imageSizeElement = document.getElementById('metaImageSize');
                    if (imageSizeElement) {
                        imageSizeElement.textContent = imageData.info.image_size;
                    }
                }
            } catch (error) {
                console.error('Error updating metadata:', error);
            }
        }
        
        function updateButtonStates() {
            if (!isImagesAvailable()) {
                return;
            }
            
            try {
                document.getElementById('firstBtn').disabled = currentSliceIndex === 0;
                document.getElementById('prevBtn').disabled = currentSliceIndex === 0;
                document.getElementById('nextBtn').disabled = currentSliceIndex === images.length - 1;
                document.getElementById('lastBtn').disabled = currentSliceIndex === images.length - 1;
            } catch (error) {
                console.error('Error updating button states:', error);
            }
        }
        
        function nextSlice() {
            if (!isImagesAvailable()) {
                console.warn('No images available for navigation');
                return;
            }
            
            if (currentSliceIndex < images.length - 1) {
                goToSlice(currentSliceIndex + 1);
            }
        }
        
        function previousSlice() {
            if (!isImagesAvailable()) {
                console.warn('No images available for navigation');
                return;
            }
            
            if (currentSliceIndex > 0) {
                goToSlice(currentSliceIndex - 1);
            }
        }
        
        function togglePlayback() {
            if (!isImagesAvailable()) {
                console.warn('No images available for playback');
                return;
            }
            
            if (isPlaying) {
                stopPlayback();
            } else {
                startPlayback();
            }
        }
        
        function startPlayback() {
            if (!isImagesAvailable()) {
                console.warn('No images available for playback');
                return;
            }
            
            try {
                isPlaying = true;
                const playBtn = document.getElementById('playBtn');
                if (playBtn) {
                    playBtn.innerHTML = '‚è∏ Pause';
                    playBtn.className = 'btn btn-warning btn-nav';
                }
                
                playbackInterval = setInterval(() => {
                    if (currentSliceIndex < images.length - 1) {
                        nextSlice();
                    } else {
                        // Loop back to start
                        goToSlice(0);
                    }
                }, 1000 / playbackSpeed);
            } catch (error) {
                console.error('Error starting playback:', error);
            }
        }
        
        function stopPlayback() {
            try {
                isPlaying = false;
                const playBtn = document.getElementById('playBtn');
                if (playBtn) {
                    playBtn.innerHTML = '‚ñ∂ Play';
                    playBtn.className = 'btn btn-success btn-nav';
                }
                
                if (playbackInterval) {
                    clearInterval(playbackInterval);
                    playbackInterval = null;
                }
            } catch (error) {
                console.error('Error stopping playback:', error);
            }
        }
        
        function updatePlaybackSpeed(speed) {
            try {
                playbackSpeed = parseInt(speed);
                const speedValueElement = document.getElementById('speedValue');
                if (speedValueElement) {
                    speedValueElement.textContent = speed;
                }
                
                // Restart playback with new speed if currently playing
                if (isPlaying && isImagesAvailable()) {
                    stopPlayback();
                    startPlayback();
                }
            } catch (error) {
                console.error('Error updating playback speed:', error);
            }
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (!isImagesAvailable()) {
                return; // Don't handle keyboard shortcuts if no images
            }
            
            switch(e.key) {
                case 'ArrowLeft':
                    e.preventDefault();
                    previousSlice();
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    nextSlice();
                    break;
                case ' ':
                    e.preventDefault();
                    togglePlayback();
                    break;
                case 'Home':
                    e.preventDefault();
                    goToSlice(0);
                    break;
                case 'End':
                    e.preventDefault();
                    goToSlice(images.length - 1);
                    break;
            }
        });
        
        // Initialize
        if (isImagesAvailable()) {
            updateButtonStates();
        }
        
        // Global error handler for JavaScript errors
        window.addEventListener('error', function(e) {
            console.error('JavaScript error:', e.error);
            console.error('Error message:', e.message);
            console.error('File:', e.filename);
            console.error('Line:', e.lineno);
            console.error('Column:', e.colno);
        });
        
        // Add help text
        document.addEventListener('DOMContentLoaded', function() {
            const helpText = document.createElement('div');
            helpText.className = 'alert alert-info mt-3';
            helpText.innerHTML = '<strong>Keyboard Shortcuts:</strong> ‚Üê ‚Üí (navigate), Space (play/pause), Home/End (first/last slice)';
            document.querySelector('.container-fluid').appendChild(helpText);
        });
    </script>
</body>
</html>